# Session Notes: 2026-01-30 - SSR Nuxt/Nitro PoC

## Summary

First session on the SSR Nuxt/Nitro PoC project. Established architecture decisions, created project structure, and scaffolded Terraform infrastructure. Ready to implement Nuxt app and deploy.

---

## ‚úÖ Decisions Made

| Decision | Choice | Rationale |
|----------|--------|-----------|
| Architecture | **Option A**: CloudFront Origin Failover | Fast failover, full Nitro features |
| App Concept | **Server Clock + Weather Dashboard** | Demonstrates SSR, region awareness, external API calls |
| Data Layer | **DynamoDB Global Tables** | Active-active, serverless, simple |
| Primary Region | **us-east-1** | CloudFront requirement, lower latency for east coast |
| DR Region | **us-west-2** | Geographic separation, mature region |
| Weather API | **Open-Meteo** | Free, no API key needed |
| IP Geolocation | **ipapi.co** or built-in | Simple for PoC |

---

## üèóÔ∏è Project Structure Created

```ini
ssr-nuxt-nitro-poc/
‚îú‚îÄ‚îÄ Project Sketch - SSR Nuxt Nitro PoC.md    # Architecture document
‚îú‚îÄ‚îÄ 2026-01-30.md                              # This session note
‚îú‚îÄ‚îÄ terraform/                                 # IaC for AWS infrastructure
‚îÇ   ‚îú‚îÄ‚îÄ main.tf                                # Provider config, locals
‚îÇ   ‚îú‚îÄ‚îÄ variables.tf                           # Input variables (env, domain, etc.)
‚îÇ   ‚îú‚îÄ‚îÄ outputs.tf                             # Outputs (Lambda URLs, CloudFront domain)
‚îÇ   ‚îú‚îÄ‚îÄ lambda.tf                              # Lambda functions (primary + DR)
‚îÇ   ‚îú‚îÄ‚îÄ dynamodb.tf                            # Global Table with replicas
‚îÇ   ‚îú‚îÄ‚îÄ s3.tf                                  # Static asset buckets + CRR config
‚îÇ   ‚îú‚îÄ‚îÄ cloudfront.tf                          # Distribution with Origin Group failover
‚îÇ   ‚îú‚îÄ‚îÄ route53.tf                             # Health checks + failover routing
‚îÇ   ‚îî‚îÄ‚îÄ modules/                               # Reusable modules
‚îÇ       ‚îî‚îÄ‚îÄ lambda/                            # Lambda module (avoids duplication)
‚îÇ           ‚îú‚îÄ‚îÄ main.tf                        # Function, role, policies
‚îÇ           ‚îú‚îÄ‚îÄ variables.tf                   # Function name, handler, etc.
‚îÇ           ‚îî‚îÄ‚îÄ outputs.tf                     # Function URL, ARN
‚îî‚îÄ‚îÄ app/                                       # Nuxt 3 app with Nitro (TBD)
    ‚îú‚îÄ‚îÄ src/                                   # Source code (pages, components, API routes)
    ‚îî‚îÄ‚îÄ .output/                               # Build output (Nitro lambda handler)
```

---

## üìã Terraform Resources Defined

### Compute

- [x] Lambda module (reusable)
- [x] Primary Lambda (us-east-1) with Function URL
- [x] DR Lambda (us-west-2) with Function URL
- [x] IAM roles and policies for Lambda execution
- [x] DynamoDB access policy

### Data

- [x] DynamoDB Global Table `ssr-poc-visits`
- [x] Primary table in us-east-1
- [x] Replica in us-west-2
- [x] Initial counter item

### Storage

- [x] S3 buckets for Lambda deployments (both regions)
- [x] S3 bucket for static assets (primary)
- [x] S3 bucket for static assets DR
- [x] Cross-Region Replication configuration
- [x] IAM role for S3 replication

### CDN & DNS

- [x] CloudFront distribution with Origin Group
- [x] Primary origin (us-east-1 Lambda URL)
- [x] DR origin (us-west-2 Lambda URL)
- [x] Static assets origin (S3)
- [x] Origin failover criteria (5xx errors, timeout)
- [x] Cache behaviors for SSR vs static assets
- [x] Route53 health checks for both regions
- [x] Route53 failover routing policy
- [x] ACM certificate (prod only)

### CI/CD & Security

- [x] Dedicated CI/CD IAM user (`ssr-poc-cicd`)
- [x] Least-privilege IAM policy for deployments
- [x] Access key for programmatic access
- [x] AWS Secrets Manager integration for credential storage
- [x] GitHub OIDC federation (optional, commented)

---

## üéØ App Features Defined

### Core Features

1. **Server Timestamp** - Proves SSR working
2. **Region Indicator** - Shows which region served request
3. **Visit Counter** - Atomic increment in DynamoDB
4. **Weather Tile** - Based on request IP geolocation
5. **Failover Test** - Manual region failure simulation

### API Endpoints

- `GET /` - SSR dashboard
- `GET /api/health` - Health check
- `POST /api/counter` - Increment counter
- `GET /api/weather` - Get weather by IP
- `POST /admin/failover` - Trigger failover test

### Data Model

```html
Table: ssr-poc-visits
PK: GLOBAL, SK: COUNTER -> count: number
PK: SESSION#<id>, SK: METADATA -> session data
```

---

## üìù Terraform Notes & Issues

### Potential Issues to Watch

1. __Lambda module role_arn__ - Currently creating separate roles; should reference shared role
2. **CloudFront origin domain** - Using `replace()` to strip `https://` from Function URLs; verify this works
3. __DynamoDB Global Table__ - Using newer `aws_dynamodb_global_table` resource; may need `aws_dynamodb_table_replica` instead
4. **S3 replication** - CRR requires versioning enabled on both buckets
5. **Route53 zone** - Assuming `pitanga.org` zone exists; need to verify

### Variables to Configure

- `environment` - Set to "dev" for initial deployment
- `domain_name` - Default `pitanga.org`
- `subdomain` - Default `ssr-poc`
- `lambda_memory_size` - Default 512MB (may need tuning)
- `lambda_timeout` - Default 10s (weather API + render time)

---

## üöÄ Next Steps

### Immediate (Next Session)

1. [ ] Create minimal Nuxt 3 app with Nitro Lambda preset
2. [ ] Implement health check endpoint
3. [ ] Implement visit counter endpoint
4. [ ] Implement weather endpoint
5. [ ] Create dashboard UI
6. [ ] Build and package Lambda deployment

### Deployment

1. [ ] Create Terraform Cloud workspace `ssr-nuxt-nitro-poc` in Pitangaville org
2. [ ] Run `terraform init` (connects to Terraform Cloud)
3. [ ] Run `terraform apply` to create all resources including CI/CD user
4. [ ] Retrieve CI/CD credentials from AWS Secrets Manager
5. [ ] Set GitHub secrets using retrieved credentials
6. [ ] Deploy app via GitHub Actions or `./deploy.sh`
7. [ ] Test Lambda Function URL directly
8. [ ] Test via CloudFront distribution
9. [ ] Test failover behavior (DR region)

### Polish

1. [ ] Add CloudWatch dashboard
2. [ ] Document cold start times
3. [ ] Document failover behavior
4. [ ] Write up findings

---

## ü§î Questions for Next Session

1. Do we deploy single-region first to validate, or go straight to multi-region?
2. Should we use Nuxt UI or keep it minimal (vanilla CSS)?
3. Do we want auth on the admin/failover endpoint?
4. Should we add WebSocket for "live" clock tick?

---

## üìö References

- **Previous Context**: Theme switcher issues in `vue-appsync` project motivated true SSR exploration
- **Nitro Lambda Preset**: https://nitro.unjs.io/deploy/providers/aws-lambda
- **Open-Meteo API**: https://open-meteo.com/
- **DynamoDB Global Tables**: https://docs.aws.amazon.com/amazondynamodb/latest/developerguide/GlobalTables.html

---

**Session Status**: Planning complete, ready to implement  
**Terraform Status**: Scaffolding complete, ready for `init`  
**Next Session Priority**: Nuxt app implementation
