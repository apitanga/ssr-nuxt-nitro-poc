# CD Workflow - Deploy Application
# 
# ⚠️  REQUIRES AWS SECRETS: This workflow needs AWS_ACCESS_KEY_ID and 
# AWS_SECRET_ACCESS_KEY to be set in GitHub repository secrets.
#
# To set up:
#   gh secret set AWS_ACCESS_KEY_ID --body "<key>" --repo apitanga/ssr-nuxt-nitro-poc
#   gh secret set AWS_SECRET_ACCESS_KEY --body "<secret>" --repo apitanga/ssr-nuxt-nitro-poc
#   gh secret set AWS_ACCOUNT_ID --body "137064409667" --repo apitanga/ssr-nuxt-nitro-poc
#
# See .github/workflows/README.md for full details.

name: CD - Deploy App

on:
  push:
    branches: [main]
    paths:
      - 'app/**'
      - '.github/workflows/cd-app.yml'
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy'
        required: true
        default: 'dev'
        type: choice
        options:
          - dev
          - prod

concurrency:
  group: deploy-app-${{ github.ref }}
  cancel-in-progress: true

jobs:
  deploy:
    name: Deploy to ${{ github.event.inputs.environment || 'dev' }}
    runs-on: ubuntu-latest
    environment: ${{ github.event.inputs.environment || 'dev' }}
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: app/package.json

      - name: Install dependencies
        working-directory: app
        run: npm install

      - name: Build for Lambda
        working-directory: app
        run: NITRO_PRESET=aws-lambda npm run build

      - name: Create deployment package
        working-directory: app
        run: |
          cd .output/server
          zip -r ../../lambda-deploy.zip .
          cd ../..
          ls -lh lambda-deploy.zip

      - name: Check for AWS credentials
        id: check-secrets
        run: |
          if [ -z "${{ secrets.AWS_ACCESS_KEY_ID }}" ]; then
            echo "has_secrets=false" >> $GITHUB_OUTPUT
            echo "⚠️  AWS secrets not configured. Skipping deployment."
            echo ""
            echo "To enable deployment, set these GitHub secrets:"
            echo "  - AWS_ACCESS_KEY_ID"
            echo "  - AWS_SECRET_ACCESS_KEY"
            echo "  - AWS_ACCOUNT_ID"
            echo ""
            echo "See .github/workflows/README.md for setup instructions."
          else
            echo "has_secrets=true" >> $GITHUB_OUTPUT
            echo "✅ AWS secrets found. Proceeding with deployment."
          fi

      - name: Configure AWS credentials
        if: steps.check-secrets.outputs.has_secrets == 'true'
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: us-east-1

      - name: Upload to S3 (Primary - us-east-1)
        if: steps.check-secrets.outputs.has_secrets == 'true'
        working-directory: app
        run: |
          aws s3 cp lambda-deploy.zip \
            s3://ssr-poc-lambda-deployments-${{ secrets.AWS_ACCOUNT_ID }}-us-east-1/lambda/nitro-ssr.zip

      - name: Upload to S3 (DR - us-west-2)
        if: steps.check-secrets.outputs.has_secrets == 'true'
        working-directory: app
        run: |
          aws s3 cp lambda-deploy.zip \
            s3://ssr-poc-lambda-deployments-${{ secrets.AWS_ACCOUNT_ID }}-us-west-2/lambda/nitro-ssr.zip \
            --region us-west-2

      - name: Update Lambda function (Primary)
        if: steps.check-secrets.outputs.has_secrets == 'true'
        run: |
          aws lambda update-function-code \
            --function-name ssr-poc-primary \
            --s3-bucket ssr-poc-lambda-deployments-${{ secrets.AWS_ACCOUNT_ID }}-us-east-1 \
            --s3-key lambda/nitro-ssr.zip \
            --publish

      - name: Update Lambda function (DR)
        if: steps.check-secrets.outputs.has_secrets == 'true'
        run: |
          aws lambda update-function-code \
            --function-name ssr-poc-dr \
            --s3-bucket ssr-poc-lambda-deployments-${{ secrets.AWS_ACCOUNT_ID }}-us-west-2 \
            --s3-key lambda/nitro-ssr.zip \
            --region us-west-2 \
            --publish

      - name: Wait for update (Primary)
        if: steps.check-secrets.outputs.has_secrets == 'true'
        run: |
          aws lambda wait function-updated-v2 \
            --function-name ssr-poc-primary

      - name: Wait for update (DR)
        if: steps.check-secrets.outputs.has_secrets == 'true'
        run: |
          aws lambda wait function-updated-v2 \
            --function-name ssr-poc-dr \
            --region us-west-2

      - name: Smoke test
        if: steps.check-secrets.outputs.has_secrets == 'true'
        run: |
          echo "Waiting for propagation..."
          sleep 10
          PRIMARY_URL=$(aws lambda get-function-url-config \
            --function-name ssr-poc-primary \
            --query 'FunctionUrl' --output text)
          echo "Testing primary: $PRIMARY_URL"
          curl -sf "$PRIMARY_URL/api/health" || exit 1
          echo "✅ Deployment successful!"

      - name: Notify (with secrets)
        if: steps.check-secrets.outputs.has_secrets == 'true'
        run: |
          echo "::notice::Deployment to ${{ github.event.inputs.environment || 'dev' }} completed!"

      - name: Notify (missing secrets)
        if: steps.check-secrets.outputs.has_secrets == 'false'
        run: |
          echo "::warning::Build succeeded but deployment skipped - AWS secrets not configured"
          echo "::warning::See .github/workflows/README.md for setup instructions"
